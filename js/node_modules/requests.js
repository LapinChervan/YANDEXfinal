var newUser = require('User'),
	util = require('util'),
	mongodb = require('mongodb'),
	db = new mongodb.Db('exampleDb', new mongodb.Server('localhost', 27017, {}), {safe: true});

var requests = (function() {
	function reg(user, password) {
		db.open(function(err, db) {
			if (!err) {
				console.log('open...');
				db.createCollection('users', function(err, collection) {
					//collection.remove(null, function(err, result) {
						if (!err) {
                            collection.findOne({name: user}, function(err, docs) {
                                if (!err && docs == null) {
                                    collection.insert(new newUser(user, password), function(err, result) {
                                        if (err) {
                                            console.log(err);
                                        } else {
                                            collection.find().toArray(function(err, docs) {
                                                console.log(util.inspect(docs));
                                                db.close();
                                            });
                                        }
                                    });
                                }
                                else {
                                    console.log('юзер создан');
                                    db.close();
                                }
                            });
						}
					//});
				});
			}
		});
	}

    function auth (user, password, res) {
        db.open(function(err, db) {
            if (!err) {
                db.collection('users',function (err, collection) {
                    if (!err) {
                        collection.findOne({name: user, password: password},
                                           {fields: {history: 0, total: 0, currency: 0, password: 0, _id: 0}},
                                           function(err, docs) {

                            if (!err && docs != null) {
                                console.log(docs);
                                res.writeHead(200, {'Content-Type': 'text/plain; charset=utf8', 'Access-Control-Allow-Origin': '*'});
                                res.end(JSON.stringify(docs));
                            }
                            else {
                                res.writeHead(200, {'Content-Type': 'text/plain; charset=utf8', 'Access-Control-Allow-Origin': '*'});
                                res.end('0');
                            }
                            db.close();
                        });
                    }
                });
            }
        });
    }

	return {
		reg: reg,
        auth: auth
	}
})();

module.exports = requests;